{{ define "main" }}
       <header>
	       <h1>{{ strings.FirstUpper .Title }}</h1>
       		<nav><a href="#posts">posts</a></nav>
       </header>
	<img style="display:block;margin: 0px auto;" width="562" height="19" src="https://web.archive.org/web/20091027102121/http://hk.geocities.com/footprints_kayi/border.gif" />
	<iframe aria-busy="true"
	      id="main_calendar"
	      src="/{{ replace (strings.ToLower .Title) ' ' '-' }}" 
	      loading="lazy"
	      onload="disappear(this)"></iframe>

	<header><h2>Dear Internet,</h2></header>
	<p>
		Here you can find some ideas or thoughts I had or maybe a picture, bookmark, or book that I found.
		Wanna chat about {{ .Title }}? Click on its hyperlink and join the conversation []~(￣▽￣)~*, messege me on
		<a href="https://micro.blog/heyloura">micro.blog</a> or on the fediverse at <a href="https://micro.blog/heyloura?remote_follow=1">@heyloura@heyloura.com</a>
	</p>
	<p>Yours truly, <a rel="author" class="p-author h-card" href="/">Loura</a></p>
	<img style="display:block;margin: 0px auto;" width="562" height="19" src="https://web.archive.org/web/20091027102121/http://hk.geocities.com/footprints_kayi/border.gif" />

  {{- $title := .Title -}}
	{{ $paginator := .Paginate (where .Pages.ByDate.Reverse "Type" "post") (index .Site.Params "archive-paginate" | default 25) }}
  <section class="h-feed">
	{{ range $paginator.Pages  }}
		<dl id="posts" class="h-entry">
    			<dt>
						{{ if .Title }}
							<a class="u-url p-name" href="{{ .Permalink }}">{{ .Title }}</a> ◊ <time class="dt-published" datetime="{{ .Date.Format "2006-01-02 15:04:05 -0700" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
						{{ else }}
							<a class="u-url p-name" href="{{ .Permalink }}"><time class="dt-published" datetime="{{ .Date.Format "2006-01-02 15:04:05 -0700" }}">{{ .Date.Format "Jan 2, 2006" }}</time></a>
						{{ end }}
  			{{- range $index, $category := .Page.Params.categories -}}
					{{ if eq $category $title }}
					{{ else }}
	   				◊&nbsp;<a class="subheading" href="/categories/{{ $category | anchorize }}/">#{{ $category }}</a> 
					{{ end }}
  			{{- end -}}
				<span data-id="{{ .RelPermalink }}"></span>
		</dt>
		{{ if in .RawContent "<!--more-->" }}
			<dd class="p-summary">
					<p>
					{{ $splitContents := split .RawContent "<!--more-->" }}
					{{ $summary := index $splitContents 0 }}
					{{ $summary := replaceRE "\\[\\^.*?\\]" "" $summary }}
					{{ $summary := replaceRE "\\n\\[\\^.*?\\]:.*" "" $summary }}
					{{ $summary | markdownify }}
					</p>
					<p><a href="{{ .Permalink }}">Read More →</a></p>
			</dd>
		{{ else }}
				{{ if .Title }}
				<dd class="e-content">
					{{ .Content | safeHTML | truncate 300 }}
					<p><a href="{{ .Permalink }}">Read More →</a></p>
				</dd>
			{{ else }}
				<dd class="e-content">
					{{ .Content }}
				</dd>
			{{ end }}
		{{ end }}
		</dl>

	  		<script>
		  fetch('https://micro.blog/conversation.js?format=jsonfeed&url=https%3A%2F%2Fheyloura.com' + encodeURIComponent('{{ .RelPermalink }}'))
		  .then(response => response.json())
		  .then(conversation => {
		    const repliesLink = document.querySelector('[data-id="{{ .RelPermalink }}"]');
		    if(conversation.items.length > 0) {
		        let postA = document.createElement('a');
		        postA.setAttribute("href", '{{ .RelPermalink }}#conversation');
		        postA.innerHTML =  conversation.items.length + (conversation.items.length == 1 ? ' comment' : ' comments');
			let postSpan = document.createElement('span');
			postSpan.innerHTML = '◊ ';
		        repliesLink.prepend(postA);
			repliesLink.prepend(postSpan);
		    } else {
		        repliesLink.remove()
		    }
		  })
		  .catch((error) => {
		    // TODO: nothing for now…
		  });
		</script>
	{{ end }}
  </section>

	<nav>
		{{ if $paginator.HasPrev }}
			<a rel='prev' href='{{ $paginator.Prev.URL }}' title='Previous Page'>← Newer Posts</a>
		{{ end }}
		{{ if $paginator.HasNext }}
			<a rel='next' href='{{ $paginator.Next.URL }}'>Older Posts →</a>
		{{ end }}
	</nav>

	<header><h2>Photobook</h2></header>
	{{- $list := where .Pages ".Params.photos" "!=" nil -}}
	{{- $len := (len $list) -}}
			<section>
				<div class="photos-grid-container" style="display: grid; grid-column-gap: 15px; grid-row-gap: 15px; grid-template-columns: 33% 33% 33%;">
			
				{{ range $index, $value := $list }}
					<a href="{{ .Permalink }}">
						{{ range first 1 .Params.photos }}
							<img src="{{ . }}" width="300" height="300" style="border-radius: 5px; max-width: 100%; height: auto;" class="photos-grid-item" loading="lazy" />
						{{ end }}
					</a>
				{{ end }}
			
				</div>
      </section>

<header><h2>Bookmarks</h2></header>
<section>
{{ $feed_url := $.Site.Params.feeds.bookmarks_json }}
{{ $response := getJSON $feed_url }}

{{ if isset $response "items" }}

{{ $tags := slice }}
{{ range $response.items }}
 {{ if not (hasPrefix .id "link") }}
    {{ $tags = $tags | append (split .tags ", ") }}
 {{ end }}
{{ end }}
{{ $tags = uniq $tags }}


<p class="heading"><small>
{{ range sort $tags }}
    {{ $tag := . }}
    {{ if not (eq $tag "") }}
 
   <a href="#{{ $tag }}">{{ $tag }}</a>

    {{ end }}
{{ end }}
</small></p>

<ul style="list-style:none;margin:0;padding:0;" class="posts">

{{ range sort $tags }}
    {{ $tag := . }}

    {{ if not (eq $tag "") }}

    <li id="{{ $tag }}"><h3 class="item-title">{{ $tag }}</h3><ul>
   {{ range $response.items }}
   {{ $url := urls.Parse .url }}
     {{ if not (hasPrefix .id "link") }}
        {{ if strings.Contains .tags $tag }}
                <li><figure style="margin: var(--space-m) 0;">
        <figcaption><cite><a target="_blank" class="u-bookmark-of" href="{{ .url }}">{{ $url.Host }}</a><br/><small>Bookmarked: {{ time.Format "Jan 2, 2006" .date_published}}</small></cite></figcaption>
        <blockquote style="padding-left: var(--space-s);border-left: 1px solid var(--text)">
          <p>{{ replace (replace ( .content_html | plainify | truncate 300 ) "Reader: " "") $url.Host "" }}</p>
        </blockquote>

      </figure></li>
        {{ end }}
     {{ end }}
    {{ end }}
    </ul></li>

    {{ end }}

{{ end }}

{{ end }}

      </ul> </section>


<script>
	/* Make the iframe hidden while loading  */
(async () => {
  let div = document.createElement('div');
  let ref = document.getElementsByTagName('base')[0] || 
            document.getElementsByTagName('script')[0];

  div.innerHTML = '<style> iframe { visibility: hidden; } </style>';
  ref.parentNode.insertBefore(div, ref);
})();  

/* Copy the contents of the iframe into the DOM and execute scripts  */
function disappear(frame) {
let body = (frame.contentDocument.body||frame.contentDocument);
let children = [...body.children];

for(let child of children) {
  let scope = child.getAttribute('data-scope');

  if(child.tagName === 'SCRIPT'){
    let script = document.createElement("script");
    script.setAttribute('data-scope', scope);    
    script.text = child.innerHTML;
    document.body.appendChild( script );
  } else if(child.tagName === 'STYLE'){
    let doc = document.implementation.createHTMLDocument("");
    let styleElement = document.createElement("style");
    styleElement.textContent = child.innerHTML;
    doc.body.appendChild(styleElement); // to compute the css rules
    child.innerHTML = '';
    
    // scope out the styles
    for(var style of styleElement.sheet.cssRules) {
      let selectors = style.selectorText;
      let scoped = [];
      
      for(var selector of selectors.split(',')){
        scoped.push(`[data-scope='${scope}'] ${selector}`);
      }
      
      child.innerHTML += style.cssText.replace(selectors, scoped.join(', ')) + ' ';
    }

    frame.before(child);
  }
  else {
	  let subchildren = [...child.children]
	  for(let subchild of subchildren) {
		  console.log(subchild);
		  if(subchild.tagName === 'ARTICLE') {
			frame.before(subchild);
		  }
	  }
  }
}

frame.remove();
}
</script>

{{ end }}
