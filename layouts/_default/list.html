{{ define "main" }}
	<header><h2>Dear Internet,</h2></header>
	<p>
		Here you can find some ideas or thoughts I had or maybe a picture, bookmark, or book that I found.
		Wanna chat about {{ .Title }}? Click on its hyperlink and join the conversation []~(￣▽￣)~*, messege me on
		<a href="https://micro.blog/heyloura">micro.blog</a> or on the fediverse at <a href="https://micro.blog/heyloura?remote_follow=1">@heyloura@heyloura.com</a>
	</p>
	<p>Yours truly, <a rel="author" class="p-author h-card" href="/">Loura</a></p>
	<img style="display:block;margin: 0px auto;" width="562" height="19" src="https://web.archive.org/web/20090803140922im_/http://hk.geocities.com/radio_monster/starsln.gif" />

	<iframe aria-busy="true"
	      id="main_calendar"
	      src="/{{ replace (strings.ToLower .Title) ' ' '-' }}" 
	      loading="lazy"
	      onload="disappear(this)"></iframe>

  {{- $title := .Title -}}
	{{ $paginator := .Paginate (where .Pages.ByDate.Reverse "Type" "post") (index .Site.Params "archive-paginate" | default 25) }}
  <section class="h-feed">
	{{ range $paginator.Pages  }}
		<dl class="h-entry">
    			<dt>
						{{ if .Title }}
							<a class="u-url p-name" href="{{ .Permalink }}">{{ .Title }}</a> ◊ <time class="dt-published" datetime="{{ .Date.Format "2006-01-02 15:04:05 -0700" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
						{{ else }}
							<a class="u-url p-name" href="{{ .Permalink }}"><time class="dt-published" datetime="{{ .Date.Format "2006-01-02 15:04:05 -0700" }}">{{ .Date.Format "Jan 2, 2006" }}</time></a>
						{{ end }}
  			{{- range $index, $category := .Page.Params.categories -}}
					{{ if eq $category $title }}
					{{ else }}
	   				◊&nbsp;<a class="subheading" href="/categories/{{ $category | anchorize }}/">#{{ $category }}</a>
					{{ end }}
  			{{- end -}}
		</dt>
		{{ if in .RawContent "<!--more-->" }}
			<dd class="p-summary">
					<p>
					{{ $splitContents := split .RawContent "<!--more-->" }}
					{{ $summary := index $splitContents 0 }}
					{{ $summary := replaceRE "\\[\\^.*?\\]" "" $summary }}
					{{ $summary := replaceRE "\\n\\[\\^.*?\\]:.*" "" $summary }}
					{{ $summary | markdownify }}
					</p>
					<p><a href="{{ .Permalink }}">Read More →</a></p>
			</dd>
		{{ else }}
				{{ if .Title }}
				<dd class="e-content">
					{{ .Content | safeHTML | truncate 300 }}
					<p><a href="{{ .Permalink }}">Read More →</a></p>
				</dd>
			{{ else }}
				<dd class="e-content">
					{{ .Content }}
				</dd>
			{{ end }}
		{{ end }}
		</dl>
	{{ end }}
  </section>

	<header><h2>Photobook</h2></header>
	{{- $list := where .Pages ".Params.photos" "!=" nil -}}
	{{- $len := (len $list) -}}
			<section>
				<div class="photos-grid-container" style="display: grid; grid-column-gap: 15px; grid-row-gap: 15px; grid-template-columns: 33% 33% 33%;">
			
				{{ range $index, $value := $list }}
					<a href="{{ .Permalink }}">
						{{ range first 1 .Params.photos }}
							<img src="{{ . }}" width="300" height="300" style="border-radius: 5px; max-width: 100%; height: auto;" class="photos-grid-item" loading="lazy" />
						{{ end }}
					</a>
				{{ end }}
			
				</div>
      </section>


<script>
	/* Make the iframe hidden while loading  */
(async () => {
  let div = document.createElement('div');
  let ref = document.getElementsByTagName('base')[0] || 
            document.getElementsByTagName('script')[0];

  div.innerHTML = '<style> iframe { visibility: hidden; } </style>';
  ref.parentNode.insertBefore(div, ref);
})();  

/* Copy the contents of the iframe into the DOM and execute scripts  */
function disappear(frame) {
let body = (frame.contentDocument.body||frame.contentDocument);
let children = [...body.children];

for(let child of children) {
  let scope = child.getAttribute('data-scope');

  if(child.tagName === 'SCRIPT'){
    let script = document.createElement("script");
    script.setAttribute('data-scope', scope);    
    script.text = child.innerHTML;
    document.body.appendChild( script );
  } else if(child.tagName === 'STYLE'){
    let doc = document.implementation.createHTMLDocument("");
    let styleElement = document.createElement("style");
    styleElement.textContent = child.innerHTML;
    doc.body.appendChild(styleElement); // to compute the css rules
    child.innerHTML = '';
    
    // scope out the styles
    for(var style of styleElement.sheet.cssRules) {
      let selectors = style.selectorText;
      let scoped = [];
      
      for(var selector of selectors.split(',')){
        scoped.push(`[data-scope='${scope}'] ${selector}`);
      }
      
      child.innerHTML += style.cssText.replace(selectors, scoped.join(', ')) + ' ';
    }

    frame.before(child);
  }
  else {
	  let subchildren = [...child.children]
	  for(let subchild of subchildren) {
		  console.log(subchild);
		  if(subchild.tagName === 'ARTICLE') {
			frame.before(subchild);
		  }
	  }
  }
}

frame.remove();
}
</script>

{{ end }}
